# 对话历史模块设计文档

添加对话历史管理功能，让用户؜能够查看和管理历史对话记录

## 思考

**为什么不直接用内存来存储会话记忆？**

> 首先是重启后会丢失记忆，其次؜如果每个应用都在内存中维护对话历史，很容易出现 OOM 问题。

是否使用 Redis 来保存呢（个人是想将其作为缓存层的），
并且项目也实际使用了 mongodb 来进行对话信息的持久化的。

### 进一步思考

或者使用 Redis 将其作为本次对话记忆存储，目的是为了让大模型有上下文记忆，简单理解就是会话记忆。
但 Redis 的内存也不是无限的，需合理设置过期时间。
而 mongodb 持久化的目的是为了在下一次打开应用时，能够恢复之前的记忆。

## 方案

**三个都使用 Redis、MySQL、MongoDB**

1. Redis：作为单个会话级别的记忆存储，其实也是 agent 的记忆存储，RedisSaver。
2. MySQL：落库存储，便于将信息同步到 Redis 中，主要功能是同步信息。
3. MongoDB：文档型数据库，便于指定字段的查找，输出是 JSON 格式的，主要功能是查询记忆。

## 流程

1. 保存 agent 回复信息到 MySQL 中
2. 将 MySQL 的历史数据同步到 Redis 中（k-v）
3. 查找对话历史时，则使用 MongoDB